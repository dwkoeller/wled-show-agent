# -----------------------------
# WLED Show Agent v3.4 — example configuration
# -----------------------------
# Copy to .env and edit.
#
# IMPORTANT:
# - Keep this service on your LAN/VLAN (do NOT expose to the public internet).
# - OPENAI_API_KEY is optional; it's only needed for /v1/command.

# --- Required ---
# Base URL of your WLED device (no trailing slash)
WLED_TREE_URL=http://172.16.200.50

# --- Safety / reliability ---
# Max brightness the service will ever set (WLED uses 0..255)
WLED_MAX_BRI=180
# Minimum time (ms) between write calls to WLED (prevents spamming)
WLED_COMMAND_COOLDOWN_MS=250
# HTTP timeout (seconds) for WLED JSON API calls
WLED_HTTP_TIMEOUT_S=2.5

# --- Segments ---
# If your WLED tree uses multiple segments (e.g. 4 outputs = 4 segments), list them here.
# For a 4-segment quarter tree, this is usually 0,1,2,3
WLED_SEGMENT_IDS=0,1,2,3
# If a generated look only targets one segment, replicate it to all segments
WLED_REPLICATE_TO_ALL_SEGMENTS=true

# --- Street-facing quadrant orientation (for 4-segment quarter trees) ---
# These settings let you say things like: "clockwise", "front", "right", etc.
# Example: segment 0 is on street-right, and segment IDs increase counterclockwise as seen from the street.
QUAD_RIGHT_SEGMENT_ID=0
QUAD_ORDER_FROM_STREET=ccw
QUAD_DEFAULT_START_POS=front

# --- Tree geometry (optional; used by some DDP patterns) ---
# These do NOT need to match WLED segments. They describe your physical mega tree layout.
TREE_RUNS=16
TREE_PIXELS_PER_RUN=196
TREE_SEGMENT_LEN=49
TREE_SEGMENTS_PER_RUN=4

# --- DDP streaming (realtime animations) ---
# Host defaults to the hostname part of WLED_TREE_URL if blank.
DDP_HOST=
DDP_PORT=4048
DDP_DESTINATION_ID=1
# DDP packets are chunked by pixels-per-packet; 480 is a safe default on Wi‑Fi.
DDP_MAX_PIXELS_PER_PACKET=480
DDP_FPS_DEFAULT=20
DDP_FPS_MAX=45
# Drop late frames to keep realtime DDP smooth.
DDP_DROP_LATE_FRAMES=true
# If lag exceeds this threshold (seconds), drop frames to catch up.
DDP_BACKPRESSURE_MAX_LAG_S=0.25
# Use the CPU process pool for DDP frame rendering (default false).
DDP_USE_CPU_POOL=false

# --- Sequence preview (GIF/MP4) ---
SEQUENCE_PREVIEW_WIDTH=120
SEQUENCE_PREVIEW_HEIGHT=24
SEQUENCE_PREVIEW_FPS=12
SEQUENCE_PREVIEW_MAX_S=20
SEQUENCE_PREVIEW_CACHE_MAX_MB=256
SEQUENCE_PREVIEW_CACHE_MAX_DAYS=7

# --- Waveform cache (server-side waveform JSON) ---
WAVEFORM_CACHE_MAX_MB=128
WAVEFORM_CACHE_MAX_DAYS=7
WAVEFORM_POINTS_DEFAULT=512

# --- OpenAI (optional; enables /v1/command) ---
OPENAI_API_KEY=
OPENAI_MODEL=gpt-5-mini
# Optional: model used for /v1/voice/transcribe (UI voice fallback).
OPENAI_STT_MODEL=gpt-4o-mini-transcribe

# --- Agent identity / A2A (agent-to-agent) ---
# Use these when you run multiple agents (tree + rooflines) and want them to coordinate.
AGENT_ID=wled-agent
AGENT_NAME=WLED Agent
AGENT_ROLE=device
# Optional: advertise a base URL for DB-discovered fleet calls (defaults to http://<AGENT_ID>:8088 in Docker).
AGENT_BASE_URL=
# Optional: comma-separated tags (for UI filtering / grouping).
AGENT_TAGS=
# Roles that are allowed to become scheduler leader (comma-separated; '*' allows any role).
SCHEDULER_LEADER_ROLES=tree,device
# Heartbeat freshness threshold used for fleet discovery (seconds).
FLEET_STALE_AFTER_S=30
# If false, disable DB-discovered targeting (role:/tag:/* and agent-id fallback); only A2A_PEERS are used.
FLEET_DB_DISCOVERY_ENABLED=true
# Fleet health fanout cache TTL (seconds).
FLEET_HEALTH_CACHE_TTL_S=15

# If set, peers must send X-A2A-Key (or Authorization: Bearer ...) to call /v1/a2a/*
A2A_API_KEY=
# Comma-separated peer definitions. Each entry can be:
# - name=http://host:port
# - http://host:port
#
# Example (when using docker compose service names):
# A2A_PEERS=roofline1=http://roofline1:8088,roofline2=http://roofline2:8088
A2A_PEERS=
A2A_HTTP_TIMEOUT_S=2.5

# Outbound retry/backoff policy for WLED/FPP/peer calls.
OUTBOUND_RETRY_ATTEMPTS=2
OUTBOUND_RETRY_BACKOFF_BASE_S=0.15
OUTBOUND_RETRY_BACKOFF_MAX_S=1.0
# Comma-separated status codes to retry (optional).
OUTBOUND_RETRY_STATUS_CODES=408,425,429,500,502,503,504

# --- Web UI + local login (required for internet-facing) ---
# UI is enabled by default at http://<host>:8088/ui
UI_ENABLED=true
#
# Auth + 2FA are required.
AUTH_ENABLED=true
AUTH_USERNAME=admin
# AUTH_PASSWORD can be plain text, or a PBKDF2 hash:
# AUTH_PASSWORD=pbkdf2_sha256$210000$<salt_b64>$<hash_b64>
AUTH_PASSWORD=
AUTH_JWT_SECRET=
AUTH_JWT_TTL_S=43200
AUTH_JWT_ISSUER=wled-show-agent
AUTH_COOKIE_NAME=wsa_token
# Set true if you terminate TLS in front of this service (recommended).
AUTH_COOKIE_SECURE=false
# CSRF protection for cookie-based auth.
AUTH_CSRF_ENABLED=true
AUTH_CSRF_COOKIE_NAME=wsa_csrf
AUTH_CSRF_HEADER_NAME=X-CSRF-Token
# Required: 6-digit TOTP code on login (Google Authenticator, 1Password, etc.)
AUTH_TOTP_ENABLED=true
AUTH_TOTP_SECRET=
AUTH_TOTP_ISSUER=wled-show-agent
# Default role for the primary AUTH_USERNAME user (admin or user).
AUTH_USER_ROLE=admin
# Optional additional users (JSON array). Each entry supports:
# - username (required)
# - password or password_hash (required)
# - totp_secret (required)
# - role (optional, default user)
# Example:
# AUTH_USERS_JSON=[{\"username\":\"operator\",\"password\":\"secret\",\"totp_secret\":\"BASE32\",\"role\":\"viewer\",\"ip_allowlist\":[\"10.0.0.0/8\"]}]
AUTH_USERS_JSON=
# Login rate limiting / lockout.
AUTH_LOGIN_MAX_ATTEMPTS=5
AUTH_LOGIN_WINDOW_S=300
AUTH_LOGIN_LOCKOUT_S=900
# Session cleanup + last_seen tracking.
AUTH_SESSION_CLEANUP_INTERVAL_S=3600
AUTH_SESSION_CLEANUP_MAX_AGE_S=0
AUTH_SESSION_TOUCH_INTERVAL_S=60

# --- CORS (optional; useful for local UI dev) ---
# If you run the UI dev server (e.g. Vite on http://localhost:5173) directly against the API,
# set one of these so browsers can call the API cross-origin.
#
# Comma-separated list of allowed origins (exact matches), e.g.:
# CORS_ALLOW_ORIGINS=http://localhost:5173
CORS_ALLOW_ORIGINS=
#
# Or allow via regex (Starlette syntax), e.g.:
# CORS_ALLOW_ORIGIN_REGEX=^https?://localhost(:\\d+)?$
CORS_ALLOW_ORIGIN_REGEX=
#
# Credentials (cookies / Authorization) require explicit origins (no '*').
CORS_ALLOW_CREDENTIALS=true

# --- Falcon Player (FPP) integration (optional) ---
# If you run Falcon Player on your LAN and want this agent to start/stop playlists or trigger events:
# FPP_BASE_URL=http://172.16.200.20
FPP_BASE_URL=
FPP_HTTP_TIMEOUT_S=2.5
# Optional extra headers (JSON object) sent on every request to FPP (auth, etc).
# Example: FPP_HEADERS_JSON={"Authorization":"Bearer <token>"}
FPP_HEADERS_JSON=

# --- LedFx integration (optional) ---
# If you run LedFx on your LAN and want this agent to control scenes/effects:
# LEDFX_BASE_URL=http://localhost:8888
LEDFX_BASE_URL=
LEDFX_HTTP_TIMEOUT_S=2.5
# Fleet status cache TTL (seconds) for LedFx summary endpoint.
LEDFX_FLEET_CACHE_TTL_S=15
# Optional extra headers (JSON object) sent on every request to LedFx (auth, etc).
# Example: LEDFX_HEADERS_JSON={"Authorization":"Bearer <token>"}
LEDFX_HEADERS_JSON=

# --- MQTT automation bridge (optional) ---
# Enable MQTT to control sequences/brightness/scheduler via a topic prefix.
# Example:
# MQTT_URL=mqtt://user:pass@192.168.1.10:1883
MQTT_URL=
MQTT_ENABLED=
MQTT_USERNAME=
MQTT_PASSWORD=
# Base topic defaults to "wsa/<AGENT_ID>" if not set.
MQTT_BASE_TOPIC=
# QoS 0-2
MQTT_QOS=0
# Publish status payload at this interval (seconds). 0 disables.
MQTT_STATUS_INTERVAL_S=15
# Reconnect delay (seconds) on failure.
MQTT_RECONNECT_INTERVAL_S=5
# Home Assistant discovery (optional).
HA_MQTT_DISCOVERY_ENABLED=false
HA_MQTT_DISCOVERY_PREFIX=homeassistant
HA_MQTT_ENTITY_PREFIX=

# --- Data directory inside container (normally leave this alone) ---
DATA_DIR=/data
# Restrict raw PUT /v1/files/upload to the same allowlist as the multipart upload.
FILES_UPLOAD_ALLOWLIST_ONLY=false

# --- Pack ingestion limits (UI: Tools → Packs) ---
# Limits are enforced when uploading/unpacking zip packs via PUT /v1/packs/ingest.
PACK_MAX_FILES=4000
PACK_MAX_UNPACKED_MB=500

# --- Backup / Restore limits ---
BACKUP_MAX_ZIP_MB=512
BACKUP_MAX_UNPACKED_MB=2048
BACKUP_MAX_FILE_MB=256
BACKUP_MAX_FILES=20000
BACKUP_EXCLUDE_GLOBS=
BACKUP_SPOOL_MAX_MB=50

# --- Database (required) ---
# Recommended (Docker): use the built-in MySQL service.
# If you run the API directly on your host instead of Docker, change `db` to `localhost`,
# or use SQLite (e.g. sqlite:////tmp/wsa.sqlite).
DATABASE_URL=mysql://wsa:wsa@db:3306/wsa
# Run Alembic migrations on startup (set false if you manage migrations externally).
DB_MIGRATE_ON_STARTUP=true

# If true, reconcile SQL metadata tables from files under DATA_DIR on startup.
DB_RECONCILE_ON_STARTUP=true
# Optional periodic reconcile (seconds, 0 disables).
DB_RECONCILE_INTERVAL_S=0
DB_RECONCILE_SCAN_LIMIT=5000
DB_RECONCILE_AUDIO=false
PRECOMPUTE_PREVIEWS_ON_INGEST=true
PRECOMPUTE_WAVEFORMS_ON_INGEST=true
PRECOMPUTE_PREVIEWS_ON_RECONCILE=true
PRECOMPUTE_WAVEFORMS_ON_RECONCILE=true

# Job history retention (SQL). Set to 0 to disable a limit.
JOB_HISTORY_MAX_ROWS=2000
JOB_HISTORY_MAX_DAYS=30
JOB_HISTORY_MAINTENANCE_INTERVAL_S=3600

# Metrics history sampling (SQL time-series for /v1/metrics).
METRICS_HISTORY_INTERVAL_S=30
METRICS_HISTORY_MAX_ROWS=10000
METRICS_HISTORY_MAX_DAYS=14
METRICS_HISTORY_MAINTENANCE_INTERVAL_S=3600

# Scheduler action history retention (SQL). Set to 0 to disable a limit.
SCHEDULER_EVENTS_MAX_ROWS=5000
SCHEDULER_EVENTS_MAX_DAYS=30
SCHEDULER_EVENTS_MAINTENANCE_INTERVAL_S=3600

# SQL metadata retention (UI helper tables). Set to 0 to disable a limit.
PACK_INGESTS_MAX_ROWS=500
PACK_INGESTS_MAX_DAYS=365
PACK_INGESTS_MAINTENANCE_INTERVAL_S=3600

SEQUENCE_META_MAX_ROWS=2000
SEQUENCE_META_MAX_DAYS=365
SEQUENCE_META_MAINTENANCE_INTERVAL_S=3600

AUDIO_ANALYSES_MAX_ROWS=1000
AUDIO_ANALYSES_MAX_DAYS=90
AUDIO_ANALYSES_MAINTENANCE_INTERVAL_S=3600

SHOW_CONFIGS_MAX_ROWS=1000
SHOW_CONFIGS_MAX_DAYS=365
SHOW_CONFIGS_MAINTENANCE_INTERVAL_S=3600

FSEQ_EXPORTS_MAX_ROWS=1000
FSEQ_EXPORTS_MAX_DAYS=365
FSEQ_EXPORTS_MAINTENANCE_INTERVAL_S=3600

FPP_SCRIPTS_MAX_ROWS=1000
FPP_SCRIPTS_MAX_DAYS=365
FPP_SCRIPTS_MAINTENANCE_INTERVAL_S=3600
AUDIT_LOG_MAX_ROWS=2000
AUDIT_LOG_MAX_DAYS=30
AUDIT_LOG_MAINTENANCE_INTERVAL_S=3600
EVENTS_HISTORY_MAX_ROWS=5000
EVENTS_HISTORY_MAX_DAYS=7
EVENTS_HISTORY_MAINTENANCE_INTERVAL_S=3600
EVENTS_SPOOL_PATH=
EVENTS_SPOOL_MAX_MB=50
EVENTS_SPOOL_FLUSH_INTERVAL_S=30
ORCHESTRATION_RUNS_MAX_ROWS=1000
ORCHESTRATION_RUNS_MAX_DAYS=90
ORCHESTRATION_RUNS_MAINTENANCE_INTERVAL_S=3600
AGENT_HISTORY_MAX_ROWS=2000
AGENT_HISTORY_MAX_DAYS=14
AGENT_HISTORY_MAINTENANCE_INTERVAL_S=3600
AGENT_HISTORY_INTERVAL_S=300

# Job queue tuning (backpressure + concurrency).
JOB_MAX_JOBS=200
JOB_QUEUE_SIZE=50
JOB_WORKER_COUNT=2

# Prometheus /metrics access (when AUTH_ENABLED=true).
# - If METRICS_PUBLIC=true, /metrics is always accessible.
# - Otherwise, set a token and send it as a header for scraping.
METRICS_PUBLIC=false
METRICS_SCRAPE_TOKEN=
METRICS_SCRAPE_HEADER=X-Metrics-Token

# API rate limiting.
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS_PER_MINUTE=600
RATE_LIMIT_BURST=120
RATE_LIMIT_SCOPE=ip
RATE_LIMIT_EXEMPT_PATHS=
RATE_LIMIT_BUCKET_TTL_S=600
RATE_LIMIT_CLEANUP_INTERVAL_S=30
RATE_LIMIT_TRUST_PROXY_HEADERS=false

# Blocking worker pool (CPU-bound tasks like xLights import / audio analysis).
BLOCKING_MAX_WORKERS=4
BLOCKING_MAX_QUEUE=16
BLOCKING_QUEUE_TIMEOUT_S=2.0
# DDP frame rendering uses a separate pool.
DDP_BLOCKING_MAX_WORKERS=1
DDP_BLOCKING_MAX_QUEUE=2
DDP_BLOCKING_QUEUE_TIMEOUT_S=0.05
CPU_POOL_MAX_WORKERS=2
CPU_POOL_MAX_QUEUE=8
CPU_POOL_QUEUE_TIMEOUT_S=2.0
#
# These are only used by the optional MySQL container in docker-compose.yml / docker-compose.fleet.yml:
MYSQL_DATABASE=wsa
MYSQL_USER=wsa
MYSQL_PASSWORD=wsa
MYSQL_ROOT_PASSWORD=wsa_root

# --- Non-WLED pixel controllers (ESPixelStick) ---
# Default is WLED mode:
# CONTROLLER_KIND=wled
#
# For an ESPixelStick-style controller (sACN / Art-Net), run the `pixel_main` app and set:
# CONTROLLER_KIND=pixel
# PIXEL_PROTOCOL=e131   # e131 or artnet
# PIXEL_HOST=172.16.200.60
# PIXEL_COUNT=50
# PIXEL_UNIVERSE_START=1
# PIXEL_CHANNELS_PER_UNIVERSE=510
# PIXEL_PORT=5568
# PIXEL_PRIORITY=100
# PIXEL_SOURCE_NAME=Star ESP
